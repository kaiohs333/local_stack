service: crud-serveless

frameworkVersion: '2'
variablesResolutionMode: 20210326

plugins:
  - serverless-localstack

custom:
  localstack:
    host: http://localhost
    edgePort: 4566
    stages:
      - local
    lambda:
      mountCode: true # Mounts local code to LocalStack Lambda, useful for debugging
    # For DynamoDB, SNS, API Gateway
    services:
      dynamodb:
        port: 4566
      sns:
        port: 4566
      apigateway:
        port: 4566
      lambda:
        port: 4566
    # autostart: true # Automatically starts LocalStack if not running
    # docker: true # Use Docker to run LocalStack

provider:
  name: aws
  runtime: nodejs14.x
  lambdaHashingVersion: 20201221
  region: us-east-1 # You can change this to your desired region
  # Add IAM permissions later
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Scan
          Resource: "arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/ItemsTable"
        - Effect: Allow
          Action:
            - sns:Publish
          Resource: { "Fn::GetAtt": ["CrudEventsTopic", "TopicArn"] }

functions:
  createItem:
    handler: handler.createItem
    events:
      - httpApi:
          path: /items
          method: post
    environment:
      ITEMS_TABLE: ${self:resources.Resources.ItemsTable.Properties.TableName}
      SNS_TOPIC_ARN: { "Fn::GetAtt": ["CrudEventsTopic", "TopicArn"] }
  getAllItems:
    handler: handler.getAllItems
    events:
      - httpApi:
          path: /items
          method: get
    environment:
      ITEMS_TABLE: ${self:resources.Resources.ItemsTable.Properties.TableName}
  getItem:
    handler: handler.getItem
    events:
      - httpApi:
          path: /items/{id}
          method: get
    environment:
      ITEMS_TABLE: ${self:resources.Resources.ItemsTable.Properties.TableName}
  updateItem:
    handler: handler.updateItem
    events:
      - httpApi:
          path: /items/{id}
          method: put
    environment:
      ITEMS_TABLE: ${self:resources.Resources.ItemsTable.Properties.TableName}
      SNS_TOPIC_ARN: { "Fn::GetAtt": ["CrudEventsTopic", "TopicArn"] }
  deleteItem:
    handler: handler.deleteItem
    events:
      - httpApi:
          path: /items/{id}
          method: delete
    environment:
      ITEMS_TABLE: ${self:resources.Resources.ItemsTable.Properties.TableName}
      SNS_TOPIC_ARN: { "Fn::GetAtt": ["CrudEventsTopic", "TopicArn"] }
  snsListener:
    handler: handler.snsListener
    events:
      - sns:
          topicName: ${self:resources.Resources.CrudEventsTopic.Properties.TopicName}
          arn: { "Fn::GetAtt": ["CrudEventsTopic", "TopicArn"] }

resources:
  Resources:
    ItemsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ItemsTable
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
    CrudEventsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: crud-events-topic